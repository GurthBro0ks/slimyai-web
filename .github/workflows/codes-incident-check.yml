name: Codes Incident Monitor

on:
  workflow_run:
    workflows: ["Aggregate Codes (Scheduled)"]
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  check-health:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check recent workflow runs
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get last 5 workflow runs
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: 'aggregate-codes.yml',
              per_page: 5,
            });

            const recentRuns = runs.data.workflow_runs.slice(0, 3);
            const failureCount = recentRuns.filter(r => r.conclusion === 'failure').length;

            core.setOutput('consecutive_failures', failureCount);
            core.setOutput('should_alert', failureCount >= 3 ? 'true' : 'false');

            return {
              failureCount,
              shouldAlert: failureCount >= 3,
              runs: recentRuns.map(r => ({
                id: r.id,
                status: r.conclusion,
                url: r.html_url
              }))
            };

      - name: Create or update incident issue
        if: steps.check.outputs.should_alert == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const label = 'codes:incident';

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: label,
              state: 'open',
            });

            const title = 'ðŸš¨ Codes Aggregator: Multiple Source Failures';
            const body = `
            ## Incident Report

            The codes aggregator has experienced **3 consecutive failures**.

            ### Recent Runs
            Check the [workflow runs](https://github.com/${owner}/${repo}/actions/workflows/aggregate-codes.yml) for details.

            ### Possible Causes
            - API credentials expired or invalid
            - Source API changes or downtime
            - Network issues
            - Rate limiting

            ### Actions Required
            1. Check workflow logs for specific errors
            2. Verify API credentials in repository secrets
            3. Test individual adapters manually
            4. Check source API status pages

            ### Health Check
            Visit: \`/api/codes/health\` endpoint

            ---
            *Auto-generated by incident monitor at ${new Date().toISOString()}*
            `;

            if (issues.data.length > 0) {
              // Update existing issue
              const issue = issues.data[0];
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: `ðŸ”„ Issue still occurring as of ${new Date().toISOString()}\n\nSee latest workflow runs above.`,
              });
              core.info(`Updated existing incident issue #${issue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: [label, 'bug'],
              });
              core.info(`Created incident issue #${newIssue.data.number}`);
            }
